<!DOCTYPE html> 
<html> 
<body> 


<video width="400" controls>
  <source src="./finalCut.mp4" type="video/mp4">
  Your browser does not support HTML5 video.
</video>
<link rel="stylesheet" href="style.css" type="text/css" />

<p>These are the frames' images generated by getVideoImage():</p>
<ol id="olFrames"></ol>

<script type="text/JavaScript">
var framesArray = [];
var isDanger = false;
var message = "Result: Your video has no weapons detected";
function getVideoImage(path, secs, callback) {
  var me = this, video = document.createElement('video');
  video.onloadedmetadata = function() {
    if ('function' === typeof secs) {
      secs = secs(this.duration);
    }
    this.currentTime = Math.min(Math.max(0, (secs < 0 ? this.duration : 0) + secs), this.duration);
  };
  video.onseeked = function(e) {
    var canvas = document.createElement('canvas');
    canvas.height = video.videoHeight;
    canvas.width = video.videoWidth;
    var ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    var img = new Image();
    img.src = canvas.toDataURL();
    framesArray.push(img.src)
    callback.call(me, img, this.currentTime, e);
  };
  video.onerror = function(e) {
    callback.call(me, undefined, undefined, e);
  };
  video.src = path;
}

function showImageAt(secs) {
  var duration;
  getVideoImage(
    './finalCut.mp4',
    function(totalTime) {
      duration = totalTime;
      return secs;
    },
    function(img, secs, event) {
      if (event.type == 'seeked') {
        var li = document.createElement('li');
        li.innerHTML += '<b>Frame at second ' + secs + ':</b><br />';
        li.appendChild(img);
        document.getElementById('olFrames').appendChild(li);
        if (duration >= ++secs) {
          showImageAt(secs);
        };
      }
    }
  );
}
//showImageAt(0);

function dangerDetection(){
    console.log("Begin to execute dangerDetection()")
    // Instantiate a client with your endpoint and key. Create a ApiKeyCredentials object with 
    // your key and endpoint, and use it to create a ComputerVisionClient object.
  
  
  
    // console.log("this is key")
    // console.log(key)
    // const computerVisionClient = new ComputerVisionClient(
    //   new ApiKeyCredentials({ inHeader: { 'Ocp-Apim-Subscription-Key': key } }), endpoint);
  
    //assign whether the image contains dangerous objects to false 
    
    console.log("before analyze danger")
    
    for (let f = 0; f < framesArray.length; f++) {
    //analyze each given frame
        if (analyzeIfDanger(framesArray[f]) == true){
        //if (isDanger == true){
          message = "Result: Your video has weapons detected"; ;
          
        }
        break;
    }
    displayMessage(message);
    return;
  }
       
  
  
    //******************************** 
    async function analyzeIfDanger(frame){
      console.log("Begin to execute analyzeIfDanger()")
      //console.log("this is frame")
      //console.log(frame)
  
      let flagTags = ["weapon", "firearm", "rifle", "ranged weapon", "gun", 
        "shooting", "assault rifle", "gun barrel", "machine gun", "trigger", 
        "explosive weapon", "air gun", "sniper rifle", "handgun", "gun",
        "pistol", "revolver", "military"];
  
      const key = 'd0fe24bef18346caaa9e38d77bde5dd0';
      const endpointTags = 'https://compvisionvideo.cognitiveservices.azure.com/vision/v3.2/analyze?visualFeatures=Tags';
      const endpointDescription = 'https://compvisionvideo.cognitiveservices.azure.com/vision/v2.1/analyze?visualFeatures=Description';
  
    //   let resp = await fetch (uriBase + '?' + params.toString(), {
    //     method: 'POST',  //WHAT TYPE OF REQUEST?
    //     body: img,  //WHAT ARE WE SENDING TO THE API?
    //     headers: {
    //         'Content-Type': 'application/octet-stream',
    //         'Ocp-Apim-Subscription-Key': subscriptionKey
    //     }
    // })
    // let data = await resp.json();


      //get tags
      let resp = await fetch(endpointTags,{
        method:'POST',
        //body: "./weapon.jpeg",
        //body: frame,
        
        // body: JSON.stringify({
        //   "url": "https://upload.wikimedia.org/wikipedia/commons/1/17/Beyonc%C3%A9_at_The_Lion_King_European_Premiere_2019.png"
        // }),

        body: JSON.stringify({
          "url": "https://cdn.britannica.com/73/130773-050-080A8034/Browning-Hi-Power-pistol.jpg"
        }),

        // body: JSON.stringify({
        //   "url": frame
        // }),
  

        headers:{
          "Content-Type": 'application/json',
          "Ocp-Apim-Subscription-Key": key
        }
      });
      let tagsResponse = await resp.json();

      console.log("POST REQUEST IS SUCESSFULL");
      //console.log("tagsResponse ");
      //console.log(tagsResponse);

      //check if any tag is in flagTags, if so -> isDanger becomes true
    //   for (let i = 0; i < tagsResponse.tags.length; i++) {
    //     console.log("Checking this tag")
    //     console.log(tagsResponse.tags[i].name)
    //     for (let j = 0; j < flagTags.length; j++){
    //       console.log("Matching with this flag")
    //       console.log(flagTags[j])
    //       if (tagsResponse.tags[0].name === flagTags[j]){
    //         isDanger = true;
    //         console.log("Your frame is Dangerous")
    //         break;
    //       }
    //       console.log("Your frame is NOT Dangerous")

    //     }
    //     if (isDanger == true){
    //         break;
    //     }
    //   }
    // }

      for (let i = 0; i < tagsResponse.tags.length; i++) {
        //console.log("This is tagsResponse.tags")
        //console.log(tagsResponse.tags.length)
          for (let j = 0; j < flagTags.length; j++){
            // console.log("This is picture tag")
            // console.log(tagsResponse.tags[i].name)
            // console.log("This is flag")
            // console.log(flagTags[j])
            if (tagsResponse.tags[i].name === flagTags[j]){
              isDanger = true;
              console.log("Your frame is Dangerous, I am returning this function")
              return true;
            }
            else{
              console.log("Your frame is NOT Dangerous , I am contnnuini")
            }
          }
        }
        return false;
      }
    
  
    //best case - notify authorities(me) by a text with the message through Twilio
    //ok case - output the message on website 
    function displayMessage(message){
      console.log("Begin to execute takeAction()")
      console.log(message);
      return;
    }
</script>
<br></br>
<input id="button" type="button" onclick="showImageAt(0)" value="Show frames">

<!-- <input id="button3" type="button" onclick="analyzeIfDanger()" value="Start detection"> -->
<input id="button3" type="button" onclick="dangerDetection()" value="Start detection">

<p>
Video courtesy of 
<a href="https://www.bigbuckbunny.org/" target="_blank">Big Buck Bunny</a>.
</p>
</body> 
</html>